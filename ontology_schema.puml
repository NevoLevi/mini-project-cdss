@startuml ontology_schema
hide circle
skinparam classAttributeIconSize 0
skinparam shadowing false
skinparam classFontStyle bold

' Core classes
class Patient {
  +hasGender: String
}

abstract class Observation {
  numericValue: Decimal [0..1]
  symbolicValue: String [0..1]
}

class HemoglobinObservation
class WBCObservation
class FeverObservation
class ChillsObservation
class SkinLookObservation
class AllergenicObservation as "AllergicStateObservation"
class TherapyStatusObservation

HemoglobinObservation -up-|> Observation
WBCObservation -up-|> Observation
FeverObservation -up-|> Observation
ChillsObservation -up-|> Observation
SkinLookObservation -up-|> Observation
"AllergicStateObservation" -up-|> Observation
TherapyStatusObservation -up-|> Observation

class State
class HemoglobinState
class HematologicalState
class SystemicToxicityGrade {
  aggregation: "MAX"  ' policy hint
}

HemoglobinState -up-|> State
HematologicalState -up-|> State
SystemicToxicityGrade -up-|> State

class RangeSpec {
  label: String
  minVal: Decimal
  maxVal: Decimal
}

class Partition {
  label: String
  minVal: Decimal [0..1]
  maxVal: Decimal [0..1]
}

class MatrixCell {
  label: String
}

class SymptomToGradeRule {
  label: String [0..1]
  minVal: Decimal [0..1]
  maxVal: Decimal [0..1]
}

' Associations
Patient "1" -- "0..*" Observation : hasObservation
Patient "1" -- "0..*" State : hasState

RangeSpec "1" --> "1" State : mapsToState
Partition "1" --> "1" Observation : partitionOf
MatrixCell "1" --> "1" Partition : hgbPartition
MatrixCell "1" --> "1" Partition : wbcPartition
MatrixCell "1" --> "1" State : mapsTo
SymptomToGradeRule "0..*" --> "1" TherapyStatusObservation : appliesIfTherapy
SymptomToGradeRule "1" --> "1" Observation : symptomObservation
SymptomToGradeRule "1" --> "1" SystemicToxicityGrade : yieldsGrade

note right of RangeSpec
  Used for Hb thresholds per gender.
  Logic (informal):
    if hasGender in {male|female}
    and Hb numericValue in [minVal, maxVal)
    then assign mapsToState
end note

note right of MatrixCell
  Represents one cell in the HbÃ—WBC matrix (per gender).
  Given a patient's Hb and WBC partitions, the cell's
  mapped State is assigned.
end note

note right of SymptomToGradeRule
  Gated by therapy (e.g., CCTG522).
  For numeric Fever, use minVal/maxVal intervals.
  For symbolic symptoms (Chills/Skin/Sensitivity),
  use 'label' to hold the symbolic value.
end note
@enduml